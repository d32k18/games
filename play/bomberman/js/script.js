function SHORTEN_PATH(El,Ik){for(;El.path.length>Ik;)El.path.shift();return El}function InjectAI(El){return El.isAI=!0,{player:El,isAI:!0,isRisky:!1,LastPos:{x:-1,y:-1},NotMovingCount:0,SafePathMode:!1,NotMoving:function(){var El=this.player.PositionFoot();return this.LastPos.x==El.x&&this.LastPos.y==El.y},IsAIDeadLock:function(){if(null==this.player.AIPlan)return!1;var El=this.player.CellOnFoot(),Ik=MAP.CellPosToXY(this.player.AIPlan.x,this.player.AIPlan.y);if(null!=MAP.BombsMatrix[Ik.y][Ik.x]&&Ik.x!=El.x&&Ik.y!=El.y)return!0;for(var hn=[{x:0,y:0},{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],SB=0;SB<hn.length;SB++)if(El.x+hn[SB].x==Ik.x&&El.y+hn[SB].y==Ik.y)return!1;return!0},IsDanger:function(){var El=null!=this.player.AIPlan?this.player.AIPlan:null;if(null!=El){var Ik=MAP._CellPosToXY(El);return this.BombDanger(this.player.CellOnFoot())||this.BombDanger(Ik)||null!=MAP.ExplosionMatrix[Ik.y][Ik.x]}return this.BombDanger(this.player.CellOnFoot())},NumberOfBombsHorAndVer:function(){for(var El=this.player.CellOnFoot(),Ik={x:El.x,y:El.y},hn=0,SB=1;1;SB++){var Zd=Ik.x+SB,OJ=Ik.y;if(!MAP.IsFloor(Zd,OJ))break;null!=MAP.BombsMatrix[OJ][Zd]&&hn++}for(var SB=1;1;SB++){var Zd=Ik.x-SB,OJ=Ik.y;if(!MAP.IsFloor(Zd,OJ))break;null!=MAP.BombsMatrix[OJ][Zd]&&hn++}for(var SB=1;1;SB++){var Zd=Ik.x,OJ=Ik.y+SB;if(!MAP.IsFloor(Zd,OJ))break;null!=MAP.BombsMatrix[OJ][Zd]&&hn++}for(var SB=1;1;SB++){var Zd=Ik.x,OJ=Ik.y-SB;if(!MAP.IsFloor(Zd,OJ))break;null!=MAP.BombsMatrix[OJ][Zd]&&hn++}return hn},Update:function(){if(!this.player.dead&&!GAME.Paused){var El=MAP.MapStatusEnum,Ik=PlayerGen.PlayerKeyEnum,hn;if(this.IsAIDeadLock()?(this.player.AIPlan=null,this.player.SetCenterCell(),this.player.AIStack=this.SafePath()):this.NotMoving()?this.NotMovingCount++>=10&&this.IsDanger()&&(this.player.AIStack.path=[],this.player.AIPlan=null,this.NotMovingCount=0):(this.LastPos=this.player.PositionFoot(),this.NotMovingCount=0),this.IsEnemyClose()&&this.NumberOfBombsHorAndVer()<3){var SB,Zd={x:(SB=this.player.CellOnFoot()).x,y:SB.y,bomb:{range:this.player.BombRange}},OJ=this.__SafePathNoPoisonTile(Zd);OJ.ok&&(this.isRisky||0==this.NoOfDifferentBombsDangerOnPath(OJ.path))&&this.player.SetBomb()}if(this.IsDanger()&&this.player.AIStack.type!=AI_STACK_TYPE.DODGE)this.player.AIStack=this.SafePath(),this.player.AIPlan=null;else if(0==this.player.AIStack.path.length&&null==this.player.AIPlan)if(this.IsDanger())this.player.AIStack=this.SafePath();else{var Pp=this.GetRndTargetsArr(),hn=null;if(0!=Pp.length){if(Math.random()<=.02)hn=this.PathToWall();else{for(var Tg=0;Tg<Pp.length&&!(hn=this.PathFinder(GAME.Players[Pp[Tg]].CellOnFoot())).ok;Tg++);hn.ok||(hn=this.PathToWall())}this.player.AIStack=hn}else this.player.AIStack=this.SafePath(),this.player.AIPlan=null}if(this.player.AIStack.type!=AI_STACK_TYPE.DODGE&&this.player.AIStack.type!=AI_STACK_TYPE.PICKUP)(hn=this.PathToGoodPickUp()).ok&&hn.path.length<5&&(this.player.AIStack=hn);if(this.IsBlockClose()&&this.player.AIStack.type!=AI_STACK_TYPE.DODGE&&this.player.AIStack.type!=AI_STACK_TYPE.PICKUP&&0==this.NumberOfBombsHorAndVer()){var SB,Zd={x:(SB=this.player.CellOnFoot()).x,y:SB.y,bomb:{range:this.player.BombRange}},RL=this.SafePath(Zd);RL.ok&&0==this.NoOfDifferentBombsDangerOnPath(RL.path)&&this.__SafePathNoPoisonTile(Zd).ok&&this.player.SetBomb()}}},GetRndTargetsArr:function(){for(var El=[],Ik=[],hn=Math.floor(Math.random()*GAME.NumberOfPlayers),SB=0;SB<GAME.NumberOfPlayers;SB++)El.push((hn+SB)%GAME.NumberOfPlayers);for(var SB=0;SB<El.length;SB++)GAME.Players[El[SB]].id==this.player.id||GAME.Players[El[SB]].dead||Ik.push(El[SB]);return Ik},BombNextToTileAt:function(El,Ik){return!!MAP.IsWall(El,Ik)&&(null!=MAP.BombsMatrix[Ik+1][El]||null!=MAP.BombsMatrix[Ik-1][El]||null!=MAP.BombsMatrix[Ik][El+1]||null!=MAP.BombsMatrix[Ik][El-1])},NoOfDifferentBombsDangerOnPath:function(El){for(var Ik=this.getBombsArr(),hn=0,SB=new Array(Ik.length),Zd=0;Zd<SB.length;Zd++)SB[Zd]=!1;for(var Zd=0;Zd<El.length;Zd++)for(var OJ=0;OJ<Ik.length;OJ++)SB[OJ]||this.EmulateBombDanger(El[Zd],Ik[OJ])&&(SB[OJ]=!0,hn++);return hn},IsBlockClose:function(){for(var El=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],Ik=this.player.CellOnFoot(),hn=0;hn<El.length;hn++){var SB=MAP.PowerUpMatrix[Ik.y+El[hn].y][Ik.x+El[hn].x];if(MAP.IsWall(Ik.x+El[hn].x,Ik.y+El[hn].y))return!0;if(null!=SB&&SB.type==MAP.PowerUpEnum.PENALTY)return!0}return!1},IsEnemyClose:function(){for(var El=[{x:0,y:0},{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],Ik=this.player.CellOnFoot(),hn=0;hn<GAME.NumberOfPlayers;hn++)if(GAME.Players[hn].id!=this.player.id&&!GAME.Players[hn].dead){var SB={x:Ik.x,y:Ik.y,bomb:{range:this.player.BombRange-1}};if(this.EmulateBombDanger(GAME.Players[hn].CellOnFoot(),SB))return!0}return!1},__SafePathNoPoisonTile:function(El){El=void 0!==El?El:{x:-1e3,y:-1e3,range:0};for(var Ik=this.player.CellOnFoot(),hn=[{x:Ik.x,y:Ik.y,prev:null,len:0}],SB=MAP.Get2DArray(MAP.MapY,MAP.MapX),Zd=0;Zd<MAP.MapY;Zd++)for(var OJ=0;OJ<MAP.MapX;OJ++)SB[Zd][OJ]=!1;SB[Ik.y][Ik.x]=!0;for(var Pp=null,Tg=null,RL=!1,cl=[],LP=MAP.PowerUpMatrix;0!=hn.length;){var Ay=hn.shift();if(Tg=Ay,!this.BombDanger(Ay,El)&&(El.x!=Ay.x||El.y!=Ay.y)&&(null==LP[Ay.y][Ay.x]||null!=LP[Ay.y][Ay.x]&&LP[Ay.y][Ay.x].type!=MAP.PowerUpEnum.PENALTY)){Pp=Ay,RL=!0;break}!MAP.IsFloor(Ay.x+1,Ay.y)||SB[Ay.y][Ay.x+1]||null!=MAP.BombsMatrix[Ay.y][Ay.x+1]||null!=MAP.ExplosionMatrix[Ay.y][Ay.x+1]||El.x==Ay.x+1&&El.y==Ay.y||null!=LP[Ay.y][Ay.x+1]&&(null==LP[Ay.y][Ay.x+1]||LP[Ay.y][Ay.x+1].type==MAP.PowerUpEnum.PENALTY)||(hn.push({x:Ay.x+1,y:Ay.y,prev:Ay,len:1+Ay.len}),SB[Ay.y][Ay.x+1]=!0),!MAP.IsFloor(Ay.x-1,Ay.y)||SB[Ay.y][Ay.x-1]||null!=MAP.BombsMatrix[Ay.y][Ay.x-1]||null!=MAP.ExplosionMatrix[Ay.y][Ay.x-1]||El.x==Ay.x-1&&El.y==Ay.y||null!=LP[Ay.y][Ay.x-1]&&(null==LP[Ay.y][Ay.x-1]||LP[Ay.y][Ay.x-1].type==MAP.PowerUpEnum.PENALTY)||(hn.push({x:Ay.x-1,y:Ay.y,prev:Ay,len:1+Ay.len}),SB[Ay.y][Ay.x-1]=!0),!MAP.IsFloor(Ay.x,Ay.y+1)||SB[Ay.y+1][Ay.x]||null!=MAP.BombsMatrix[Ay.y+1][Ay.x]||null!=MAP.ExplosionMatrix[Ay.y+1][Ay.x]||El.x==Ay.x&&El.y==Ay.y+1||null!=LP[Ay.y+1][Ay.x]&&(null==LP[Ay.y+1][Ay.x]||LP[Ay.y+1][Ay.x].type==MAP.PowerUpEnum.PENALTY)||(hn.push({x:Ay.x,y:Ay.y+1,prev:Ay,len:1+Ay.len}),SB[Ay.y+1][Ay.x]=!0),!MAP.IsFloor(Ay.x,Ay.y-1)||SB[Ay.y-1][Ay.x]||null!=MAP.BombsMatrix[Ay.y-1][Ay.x]||null!=MAP.ExplosionMatrix[Ay.y-1][Ay.x]||El.x==Ay.x&&El.y==Ay.y-1||null!=LP[Ay.y-1][Ay.x]&&(null==LP[Ay.y-1][Ay.x]||LP[Ay.y-1][Ay.x].type==MAP.PowerUpEnum.PENALTY)||(hn.push({x:Ay.x,y:Ay.y-1,prev:Ay,len:1+Ay.len}),SB[Ay.y-1][Ay.x]=!0)}for(null==Pp&&(Pp=Tg);null!=Pp;)cl.push(Pp),Pp=Pp.prev;return{path:cl,ok:RL,type:AI_STACK_TYPE.DODGE}},SafePath:function(El){var Ik=this.__SafePathNoPoisonTile(El);if(Ik.ok)return Ik;El=void 0!==El?El:{x:-1e3,y:-1e3,range:0};for(var hn=this.player.CellOnFoot(),SB=[{x:hn.x,y:hn.y,prev:null,len:0}],Zd=MAP.Get2DArray(MAP.MapY,MAP.MapX),OJ=0;OJ<MAP.MapY;OJ++)for(var Pp=0;Pp<MAP.MapX;Pp++)Zd[OJ][Pp]=!1;Zd[hn.y][hn.x]=!0;for(var Tg=null,RL=null,cl=!1,LP=[];0!=SB.length;){var Ay=SB.shift();if(RL=Ay,!this.BombDanger(Ay,El)&&(El.x!=Ay.x||El.y!=Ay.y)){Tg=Ay,cl=!0;break}!MAP.IsFloor(Ay.x+1,Ay.y)||Zd[Ay.y][Ay.x+1]||null!=MAP.BombsMatrix[Ay.y][Ay.x+1]||null!=MAP.ExplosionMatrix[Ay.y][Ay.x+1]||El.x==Ay.x+1&&El.y==Ay.y||(SB.push({x:Ay.x+1,y:Ay.y,prev:Ay,len:1+Ay.len}),Zd[Ay.y][Ay.x+1]=!0),!MAP.IsFloor(Ay.x-1,Ay.y)||Zd[Ay.y][Ay.x-1]||null!=MAP.BombsMatrix[Ay.y][Ay.x-1]||null!=MAP.ExplosionMatrix[Ay.y][Ay.x-1]||El.x==Ay.x-1&&El.y==Ay.y||(SB.push({x:Ay.x-1,y:Ay.y,prev:Ay,len:1+Ay.len}),Zd[Ay.y][Ay.x-1]=!0),!MAP.IsFloor(Ay.x,Ay.y+1)||Zd[Ay.y+1][Ay.x]||null!=MAP.BombsMatrix[Ay.y+1][Ay.x]||null!=MAP.ExplosionMatrix[Ay.y+1][Ay.x]||El.x==Ay.x&&El.y==Ay.y+1||(SB.push({x:Ay.x,y:Ay.y+1,prev:Ay,len:1+Ay.len}),Zd[Ay.y+1][Ay.x]=!0),!MAP.IsFloor(Ay.x,Ay.y-1)||Zd[Ay.y-1][Ay.x]||null!=MAP.BombsMatrix[Ay.y-1][Ay.x]||null!=MAP.ExplosionMatrix[Ay.y-1][Ay.x]||El.x==Ay.x&&El.y==Ay.y-1||(SB.push({x:Ay.x,y:Ay.y-1,prev:Ay,len:1+Ay.len}),Zd[Ay.y-1][Ay.x]=!0)}for(null==Tg&&(Tg=RL);null!=Tg;)LP.push(Tg),Tg=Tg.prev;return{path:LP,ok:cl,type:AI_STACK_TYPE.DODGE}},BombDanger:function(El,Ik){var hn=this.getBombsArr();if(void 0!==Ik&&Ik.x>-1&&Ik.y>-1&&hn.push(Ik),0==hn.length)return!1;for(var SB=0;SB<hn.length;SB++)if(this.EmulateBombDanger(El,hn[SB]))return!0;return!1},EmulateBombDanger:function(El,Ik){for(var hn=Ik,SB=El,Zd={x:Ik.x,y:Ik.y},OJ=0;OJ<hn.bomb.range;OJ++){var Pp=Zd.x+OJ,Tg=Zd.y;if(!MAP.IsFloor(Pp,Tg))break;if(SB.x==Pp&&SB.y==Tg)return!0}for(var OJ=0;OJ<hn.bomb.range;OJ++){var Pp=Zd.x-OJ,Tg=Zd.y;if(!MAP.IsFloor(Pp,Tg))break;if(SB.x==Pp&&SB.y==Tg)return!0}for(var OJ=0;OJ<hn.bomb.range;OJ++){var Pp=Zd.x,Tg=Zd.y+OJ;if(!MAP.IsFloor(Pp,Tg))break;if(SB.x==Pp&&SB.y==Tg)return!0}for(var OJ=0;OJ<hn.bomb.range;OJ++){var Pp=Zd.x,Tg=Zd.y-OJ;if(!MAP.IsFloor(Pp,Tg))break;if(SB.x==Pp&&SB.y==Tg)return!0}return!1},PathFinder:function(El){for(var Ik=this.player.CellOnFoot(),hn=[{x:Ik.x,y:Ik.y,prev:null,len:0}],SB=MAP.Get2DArray(MAP.MapY,MAP.MapX),Zd=0;Zd<MAP.MapY;Zd++)for(var OJ=0;OJ<MAP.MapX;OJ++)SB[Zd][OJ]=!1;SB[Ik.y][Ik.x]=!0;for(var Pp=null,Tg=null,RL=!1,cl=[],LP=MAP.PowerUpMatrix;0!=hn.length;){var Ay=hn.shift(),wT=!1;if(Ay.x==El.x&&Ay.y==El.y){Pp=Ay,RL=!0;break}!MAP.IsFloor(Ay.x+1,Ay.y)||SB[Ay.y][Ay.x+1]||this.BombDanger({x:Ay.x+1,y:Ay.y})||null!=LP[Ay.y][Ay.x+1]&&(null==LP[Ay.y][Ay.x+1]||LP[Ay.y][Ay.x+1].type==MAP.PowerUpEnum.PENALTY)||(hn.push({x:Ay.x+1,y:Ay.y,prev:Ay,len:1+Ay.len}),SB[Ay.y][Ay.x+1]=!0,wT=!0),!MAP.IsFloor(Ay.x-1,Ay.y)||SB[Ay.y][Ay.x-1]||this.BombDanger({x:Ay.x-1,y:Ay.y})||null!=LP[Ay.y][Ay.x-1]&&(null==LP[Ay.y][Ay.x-1]||LP[Ay.y][Ay.x-1].type==MAP.PowerUpEnum.PENALTY)||(hn.push({x:Ay.x-1,y:Ay.y,prev:Ay,len:1+Ay.len}),SB[Ay.y][Ay.x-1]=!0,wT=!0),!MAP.IsFloor(Ay.x,Ay.y+1)||SB[Ay.y+1][Ay.x]||this.BombDanger({x:Ay.x,y:Ay.y+1})||null!=LP[Ay.y+1][Ay.x]&&(null==LP[Ay.y+1][Ay.x]||LP[Ay.y+1][Ay.x].type==MAP.PowerUpEnum.PENALTY)||(hn.push({x:Ay.x,y:Ay.y+1,prev:Ay,len:1+Ay.len}),SB[Ay.y+1][Ay.x]=!0,wT=!0),!MAP.IsFloor(Ay.x,Ay.y-1)||SB[Ay.y-1][Ay.x]||this.BombDanger({x:Ay.x,y:Ay.y-1})||null!=LP[Ay.y-1][Ay.x]&&(null==LP[Ay.y-1][Ay.x]||LP[Ay.y-1][Ay.x].type==MAP.PowerUpEnum.PENALTY)||(hn.push({x:Ay.x,y:Ay.y-1,prev:Ay,len:1+Ay.len}),SB[Ay.y-1][Ay.x]=!0,wT=!0),wT||null!=Tg||(Tg=Ay)}for(null==Pp&&(Pp=Tg);null!=Pp;)cl.push(Pp),Pp=Pp.prev;return{path:cl,ok:RL,type:AI_STACK_TYPE.FOLLOW}},PathToGoodPickUp:function(){for(var El=this.player.CellOnFoot(),Ik=[{x:El.x,y:El.y,prev:null,len:0}],hn=MAP.Get2DArray(MAP.MapY,MAP.MapX),SB=0;SB<MAP.MapY;SB++)for(var Zd=0;Zd<MAP.MapX;Zd++)hn[SB][Zd]=!1;hn[El.y][El.x]=!0;for(var OJ=null,Pp=null,Tg=!1,RL=[],cl=MAP.PowerUpMatrix;0!=Ik.length;){var LP=Ik.shift(),Ay=!1;if(null!=cl[LP.y][LP.x]&&cl[LP.y][LP.x].type!=MAP.PowerUpEnum.PENALTY){OJ=LP,Tg=!0;break}!MAP.IsFloor(LP.x+1,LP.y)||hn[LP.y][LP.x+1]||this.BombDanger({x:LP.x+1,y:LP.y})||null!=cl[LP.y][LP.x+1]&&(null==cl[LP.y][LP.x+1]||cl[LP.y][LP.x+1].type==MAP.PowerUpEnum.PENALTY)||(Ik.push({x:LP.x+1,y:LP.y,prev:LP,len:1+LP.len}),hn[LP.y][LP.x+1]=!0,Ay=!0),!MAP.IsFloor(LP.x-1,LP.y)||hn[LP.y][LP.x-1]||this.BombDanger({x:LP.x-1,y:LP.y})||null!=cl[LP.y][LP.x-1]&&(null==cl[LP.y][LP.x-1]||cl[LP.y][LP.x-1].type==MAP.PowerUpEnum.PENALTY)||(Ik.push({x:LP.x-1,y:LP.y,prev:LP,len:1+LP.len}),hn[LP.y][LP.x-1]=!0,Ay=!0),!MAP.IsFloor(LP.x,LP.y+1)||hn[LP.y+1][LP.x]||this.BombDanger({x:LP.x,y:LP.y+1})||null!=cl[LP.y+1][LP.x]&&(null==cl[LP.y+1][LP.x]||cl[LP.y+1][LP.x].type==MAP.PowerUpEnum.PENALTY)||(Ik.push({x:LP.x,y:LP.y+1,prev:LP,len:1+LP.len}),hn[LP.y+1][LP.x]=!0,Ay=!0),!MAP.IsFloor(LP.x,LP.y-1)||hn[LP.y-1][LP.x]||this.BombDanger({x:LP.x,y:LP.y-1})||null!=cl[LP.y-1][LP.x]&&(null==cl[LP.y-1][LP.x]||cl[LP.y-1][LP.x].type==MAP.PowerUpEnum.PENALTY)||(Ik.push({x:LP.x,y:LP.y-1,prev:LP,len:1+LP.len}),hn[LP.y-1][LP.x]=!0,Ay=!0),Ay||null!=Pp||(Pp=LP)}for(null==OJ&&(OJ=Pp);null!=OJ;)RL.push(OJ),OJ=OJ.prev;return{path:RL,ok:Tg,type:AI_STACK_TYPE.PICKUP}},PathToWall:function(){for(var El=this.player.CellOnFoot(),Ik=[{x:El.x,y:El.y,prev:null,len:0}],hn=MAP.Get2DArray(MAP.MapY,MAP.MapX),SB=0;SB<MAP.MapY;SB++)for(var Zd=0;Zd<MAP.MapX;Zd++)hn[SB][Zd]=!1;hn[El.y][El.x]=!0;for(var OJ=null,Pp=null,Tg=!1,RL=[],cl=MAP.PowerUpMatrix;0!=Ik.length;){var LP=Ik.shift(),Ay=!1;if((MAP.IsWall(LP.x-1,LP.y)||MAP.IsWall(LP.x+1,LP.y)||MAP.IsWall(LP.x,LP.y-1)||MAP.IsWall(LP.x,LP.y+1))&&(null==cl[LP.y][LP.x]||null!=cl[LP.y][LP.x]&&cl[LP.y][LP.x].type!=MAP.PowerUpEnum.PENALTY)&&!(this.BombNextToTileAt(LP.x+1,LP.y)||this.BombNextToTileAt(LP.x-1,LP.y)||this.BombNextToTileAt(LP.x,LP.y+1)||this.BombNextToTileAt(LP.x,LP.y-1))){OJ=LP,Tg=!0;break}!MAP.IsFloor(LP.x+1,LP.y)||hn[LP.y][LP.x+1]||this.BombDanger({x:LP.x+1,y:LP.y})||null!=cl[LP.y][LP.x+1]&&(null==cl[LP.y][LP.x+1]||cl[LP.y][LP.x+1].type==MAP.PowerUpEnum.PENALTY)||(Ik.push({x:LP.x+1,y:LP.y,prev:LP,len:1+LP.len}),hn[LP.y][LP.x+1]=!0,Ay=!0),!MAP.IsFloor(LP.x-1,LP.y)||hn[LP.y][LP.x-1]||this.BombDanger({x:LP.x-1,y:LP.y})||null!=cl[LP.y][LP.x-1]&&(null==cl[LP.y][LP.x-1]||cl[LP.y][LP.x-1].type==MAP.PowerUpEnum.PENALTY)||(Ik.push({x:LP.x-1,y:LP.y,prev:LP,len:1+LP.len}),hn[LP.y][LP.x-1]=!0,Ay=!0),!MAP.IsFloor(LP.x,LP.y+1)||hn[LP.y+1][LP.x]||this.BombDanger({x:LP.x,y:LP.y+1})||null!=cl[LP.y+1][LP.x]&&(null==cl[LP.y+1][LP.x]||cl[LP.y+1][LP.x].type==MAP.PowerUpEnum.PENALTY)||(Ik.push({x:LP.x,y:LP.y+1,prev:LP,len:1+LP.len}),hn[LP.y+1][LP.x]=!0,Ay=!0),!MAP.IsFloor(LP.x,LP.y-1)||hn[LP.y-1][LP.x]||this.BombDanger({x:LP.x,y:LP.y-1})||null!=cl[LP.y-1][LP.x]&&(null==cl[LP.y-1][LP.x]||cl[LP.y-1][LP.x].type==MAP.PowerUpEnum.PENALTY)||(Ik.push({x:LP.x,y:LP.y-1,prev:LP,len:1+LP.len}),hn[LP.y-1][LP.x]=!0,Ay=!0),Ay||null!=Pp||(Pp=LP)}for(null==OJ&&(OJ=Pp);null!=OJ;)RL.push(OJ),OJ=OJ.prev;return{path:RL,ok:Tg,type:AI_STACK_TYPE.FOLLOW}},getBombsArr:function(){for(var El=[],Ik=0;Ik<MAP.MapY;Ik++)for(var hn=0;hn<MAP.MapX;hn++)null!=MAP.BombsMatrix[Ik][hn]&&El.push({bomb:MAP.BombsMatrix[Ik][hn],x:hn,y:Ik});return El}}}function GetBomb(El,Ik,hn){return{x:El,y:Ik,RootPlayer:hn,range:hn.BombRange,IntervalHandle:null,SoundHandle:null,frames:[0,1,0,2],frameIdx:0,explodeMs:3e3,exploded:!1,Sound:null,SoundPlayed:!1,TimerHandle:null,Activate:function(){this.RootPlayer.MaxBombs--,this.Sound=new Audio("./audio/bomb.mp3"),this.Sound.volume=.3;var El=this;this.IntervalHandle=setInterval((function(){if(null!=El.TimerHandle){if(GAME.Paused)return void(El.TimerHandle.On()&&El.TimerHandle.pause());El.TimerHandle.On()||El.TimerHandle.resume()}El.frameIdx=(El.frameIdx+1)%El.frames.length}),500),this.SoundHandle=setInterval((function(){if(null!=El.TimerHandle){if(GAME.Paused)return void(El.TimerHandle.On()&&El.TimerHandle.pause());El.TimerHandle.On()||El.TimerHandle.resume()}El.exploded&&!El.SoundPlayed&&(El.Sound.play(),El.SoundPlayed=!0)}),50),this.TimerHandle=new Timer((function(){clearInterval(El.IntervalHandle),clearInterval(El.SoundHandle),El.RootPlayer.MaxBombs++,El.exploded=!0,El.SoundPlayed||(El.Sound.play(),El.SoundPlayed=!0)}),El.explodeMs)},Render:function(){MAP.Ctx.drawImage(GAME.SpriteBankImage,154+16*this.frames[this.frameIdx],204,15,16,MAP.TileDim*this.x+.15*MAP.TileDim,MAP.TileDim*this.y+.15*MAP.TileDim,.7*MAP.TileDim,.7*MAP.TileDim)},GetExplosion:function(){return GetExplosion(this.x,this.y,this.range)}}}function GetExplosion(El,Ik,hn){return{x:El,y:Ik,range:hn,over:!1,frameIdx:0,frames:[3,2,1,0,1,2,3],IntervalHandle:null,durationMs:500,maxX:0,minX:0,maxY:0,minY:0,maxXW:!1,minXW:!1,maxYW:!1,minYW:!1,cleaningDone:!1,TimerHandle:null,Activate:function(){var El=this;this.IntervalHandle=setInterval((function(){if(null!=El.TimerHandle){if(GAME.Paused)return void(El.TimerHandle.On()&&El.TimerHandle.pause());El.TimerHandle.On()||El.TimerHandle.resume()}El.frameIdx++,El.frameIdx==El.frames.length&&(El.frameIdx=0)}),72),this.TimerHandle=new Timer((function(){El.CleanUpExplosionMatrix(),clearInterval(El.IntervalHandle),El.over=!0}),El.durationMs)},BasicRender:function(){MAP.Ctx.drawImage(GAME.SpriteBankImage,74+16*this.frames[this.frameIdx],237,16,16,MAP.TileDim*this.x,MAP.TileDim*this.y,MAP.TileDim,MAP.TileDim);for(var El=1;1&&0!=this.minY;El++){if(this.y-El==this.minY){this.minYW?MAP.Ctx.drawImage(GAME.SpriteBankImage,266+16*this.frames[this.frameIdx],221,16,16,MAP.TileDim*this.x,MAP.TileDim*(this.y-El),MAP.TileDim,MAP.TileDim):MAP.Ctx.drawImage(GAME.SpriteBankImage,10+16*this.frames[this.frameIdx],221,16,16,MAP.TileDim*this.x,MAP.TileDim*(this.y-El),MAP.TileDim,MAP.TileDim);break}MAP.Ctx.drawImage(GAME.SpriteBankImage,266+16*this.frames[this.frameIdx],221,16,16,MAP.TileDim*this.x,MAP.TileDim*(this.y-El),MAP.TileDim,MAP.TileDim)}for(var El=1;1&&0!=this.maxY;El++){if(this.y+El==this.maxY){this.maxYW?MAP.Ctx.drawImage(GAME.SpriteBankImage,266+16*this.frames[this.frameIdx],221,16,16,MAP.TileDim*this.x,MAP.TileDim*(this.y+El),MAP.TileDim,MAP.TileDim):MAP.Ctx.drawImage(GAME.SpriteBankImage,138+16*this.frames[this.frameIdx],221,16,16,MAP.TileDim*this.x,MAP.TileDim*(this.y+El),MAP.TileDim,MAP.TileDim);break}MAP.Ctx.drawImage(GAME.SpriteBankImage,266+16*this.frames[this.frameIdx],221,16,16,MAP.TileDim*this.x,MAP.TileDim*(this.y+El),MAP.TileDim,MAP.TileDim)}for(var El=1;1&&0!=this.minX;El++){if(this.x-El==this.minX){this.minXW?MAP.Ctx.drawImage(GAME.SpriteBankImage,10+16*this.frames[this.frameIdx],237,16,16,MAP.TileDim*(this.x-El),MAP.TileDim*this.y,MAP.TileDim,MAP.TileDim):MAP.Ctx.drawImage(GAME.SpriteBankImage,202+16*this.frames[this.frameIdx],221,16,16,MAP.TileDim*(this.x-El),MAP.TileDim*this.y,MAP.TileDim,MAP.TileDim);break}MAP.Ctx.drawImage(GAME.SpriteBankImage,10+16*this.frames[this.frameIdx],237,16,16,MAP.TileDim*(this.x-El),MAP.TileDim*this.y,MAP.TileDim,MAP.TileDim)}for(var El=1;1&&0!=this.maxX;El++){if(this.x+El==this.maxX){this.maxXW?MAP.Ctx.drawImage(GAME.SpriteBankImage,10+16*this.frames[this.frameIdx],237,16,16,MAP.TileDim*(this.x+El),MAP.TileDim*this.y,MAP.TileDim,MAP.TileDim):MAP.Ctx.drawImage(GAME.SpriteBankImage,74+16*this.frames[this.frameIdx],221,16,16,MAP.TileDim*(this.x+El),MAP.TileDim*this.y,MAP.TileDim,MAP.TileDim);break}MAP.Ctx.drawImage(GAME.SpriteBankImage,10+16*this.frames[this.frameIdx],237,16,16,MAP.TileDim*(this.x+El),MAP.TileDim*this.y,MAP.TileDim,MAP.TileDim)}},CleanUpExplosionMatrix:function(){MAP.ExplosionMatrix[this.y][this.x]=null;for(var El=0;1&&0!=this.minY&&(MAP.ExplosionMatrix[this.y-El][this.x]=null,this.y-El!=this.minY);El++);for(var El=0;1&&0!=this.maxY&&(MAP.ExplosionMatrix[this.y+El][this.x]=null,this.y+El!=this.maxY);El++);for(var El=0;1&&0!=this.minX&&(MAP.ExplosionMatrix[this.y][this.x-El]=null,this.x-El!=this.minX);El++);for(var El=0;1&&0!=this.maxX&&(MAP.ExplosionMatrix[this.y][this.x+El]=null,this.x+El!=this.maxX);El++);},Render:function(){if(this.cleaningDone)this.BasicRender();else{MAP.ExplosionMatrix[this.y][this.x]=1,MAP.Ctx.drawImage(GAME.SpriteBankImage,74+16*this.frames[this.frameIdx],237,16,16,MAP.TileDim*this.x,MAP.TileDim*this.y,MAP.TileDim,MAP.TileDim);for(var El=1;El<this.range;El++){if(!MAP.IsFloor(this.x,this.y-El)){MAP.IsWall(this.x,this.y-El)&&(MAP.Map[this.y-El][this.x]=MAP.MapStatusEnum.FLOOR,MAP.WallDestroyRenderMatrix[this.y-El][this.x]=GetAnimatedWall(this.x,this.y-El),MAP.WallDestroyRenderMatrix[this.y-El][this.x].Activate()),this.minYW=!0;break}if(this.minY=this.y-El,MAP.ExplosionMatrix[this.y-El][this.x]=1,El+1>=this.range){MAP.Ctx.drawImage(GAME.SpriteBankImage,10+16*this.frames[this.frameIdx],221,16,16,MAP.TileDim*this.x,MAP.TileDim*(this.y-El),MAP.TileDim,MAP.TileDim);break}MAP.Ctx.drawImage(GAME.SpriteBankImage,266+16*this.frames[this.frameIdx],221,16,16,MAP.TileDim*this.x,MAP.TileDim*(this.y-El),MAP.TileDim,MAP.TileDim)}for(var El=1;El<this.range;El++){if(!MAP.IsFloor(this.x,this.y+El)){MAP.IsWall(this.x,this.y+El)&&(MAP.Map[this.y+El][this.x]=MAP.MapStatusEnum.FLOOR,MAP.WallDestroyRenderMatrix[this.y+El][this.x]=GetAnimatedWall(this.x,this.y+El),MAP.WallDestroyRenderMatrix[this.y+El][this.x].Activate()),this.maxYW=!0;break}if(this.maxY=this.y+El,MAP.ExplosionMatrix[this.y+El][this.x]=1,El+1>=this.range){MAP.Ctx.drawImage(GAME.SpriteBankImage,138+16*this.frames[this.frameIdx],221,16,16,MAP.TileDim*this.x,MAP.TileDim*(this.y+El),MAP.TileDim,MAP.TileDim);break}MAP.Ctx.drawImage(GAME.SpriteBankImage,266+16*this.frames[this.frameIdx],221,16,16,MAP.TileDim*this.x,MAP.TileDim*(this.y+El),MAP.TileDim,MAP.TileDim)}for(var El=1;El<this.range;El++){if(!MAP.IsFloor(this.x-El,this.y)){MAP.IsWall(this.x-El,this.y)&&(MAP.Map[this.y][this.x-El]=MAP.MapStatusEnum.FLOOR,MAP.WallDestroyRenderMatrix[this.y][this.x-El]=GetAnimatedWall(this.x-El,this.y),MAP.WallDestroyRenderMatrix[this.y][this.x-El].Activate()),this.minXW=!0;break}if(this.minX=this.x-El,MAP.ExplosionMatrix[this.y][this.x-El]=1,El+1>=this.range){MAP.Ctx.drawImage(GAME.SpriteBankImage,202+16*this.frames[this.frameIdx],221,16,16,MAP.TileDim*(this.x-El),MAP.TileDim*this.y,MAP.TileDim,MAP.TileDim);break}MAP.Ctx.drawImage(GAME.SpriteBankImage,10+16*this.frames[this.frameIdx],237,16,16,MAP.TileDim*(this.x-El),MAP.TileDim*this.y,MAP.TileDim,MAP.TileDim)}for(var El=1;El<this.range;El++){if(!MAP.IsFloor(this.x+El,this.y)){MAP.IsWall(this.x+El,this.y)&&(MAP.Map[this.y][this.x+El]=MAP.MapStatusEnum.FLOOR,MAP.WallDestroyRenderMatrix[this.y][this.x+El]=GetAnimatedWall(this.x+El,this.y),MAP.WallDestroyRenderMatrix[this.y][this.x+El].Activate()),this.maxXW=!0;break}if(this.maxX=this.x+El,MAP.ExplosionMatrix[this.y][this.x+El]=1,El+1>=this.range){MAP.Ctx.drawImage(GAME.SpriteBankImage,74+16*this.frames[this.frameIdx],221,16,16,MAP.TileDim*(this.x+El),MAP.TileDim*this.y,MAP.TileDim,MAP.TileDim);break}MAP.Ctx.drawImage(GAME.SpriteBankImage,10+16*this.frames[this.frameIdx],237,16,16,MAP.TileDim*(this.x+El),MAP.TileDim*this.y,MAP.TileDim,MAP.TileDim)}this.cleaningDone=!0}}}}AI_STACK_TYPE=Object.freeze({FOLLOW:1,DODGE:2,PICKUP:3});var GAME={SpriteBankImage:null,Players:[],Paused:!1,BackgroundAudio:null,EngineIntervalHandle:null,EndGameHandle:null,AILogicHandle:null,AISettings:null,AI:[],NumberOfPlayers:4,Init:function(){this.AISettings=GetAISettings(),this.PrepareSpritesAndInitMap(),this.PrepareAudio()},PrepareAudio:function(){this.BackgroundAudio=new Audio("./audio/background2.mp3"),this.BackgroundAudio.play(),this.BackgroundAudio.loop=!0,this.BackgroundAudio.volume=.1},PrepareSpritesAndInitMap:function(){this.SpriteBankImage=new Image;var El=this,Ik=document.getElementById("ctx"),hn=Ik.getContext("2d");this.SpriteBankImage.onload=function(){MAP.Init(Ik,hn),El.EngineStart()},this.SpriteBankImage.src="./sprites/players.png"},generateContext:function(El,Ik){var hn=document.createElement("canvas");return hn.width=El,hn.height=Ik,hn.getContext("2d")},PlayersInit:function(El){for(var Ik=(MAP.MapX-2)*MAP.TileDim,hn=(MAP.MapY-2)*MAP.TileDim,SB=1*MAP.TileDim,Zd=1*MAP.TileDim,OJ=[[SB,Zd],[Ik,hn],[Ik,Zd],[SB,hn]],Pp=0;Pp<El&&Pp<4;Pp++)this.Players.push(PlayerGen.CreatePlayer(OJ[Pp][0],OJ[Pp][1],Pp)),this.Players[Pp].SetCenterCell()},RenderPause:function(El){MAP.Ctx.fillStyle="rgba(0, 0, 0, 0.8)",MAP.Ctx.fillRect(0,0,MAP.Canvas.width,MAP.Canvas.height),MAP.Ctx.font="52px Consolas",MAP.Ctx.fillStyle="white";var Ik=MAP.Ctx.measureText(El);MAP.Ctx.fillText(El,MAP.Canvas.width/2-Ik.width/2,MAP.Canvas.height/2)},ResetBombSoundsPrevGame:function(){for(var El=0;El<MAP.MapY;El++)for(var Ik=0;Ik<MAP.MapX;Ik++)null!=MAP.BombsMatrix[El][Ik]&&null!=MAP.BombsMatrix[El][Ik].SoundHandle&&(clearInterval(MAP.BombsMatrix[El][Ik].SoundHandle),MAP.BombsMatrix[El][Ik].SoundPlayed=!0)},ResetEngine:function(){this.ResetBombSoundsPrevGame(),clearInterval(this.EngineIntervalHandle),clearInterval(this.AILogicHandle),this.EngineIntervalHandle=null,null!=this.EndGameHandle&&this.EndGameHandle.pause(),this.EndGameHandle=null,this.BackgroundAudio.src="",this.BackgroundAudio=null,this.BackgroundAudio=null,this.SpriteBankImage=null,this.AI=[],this.Players=[],this.Paused=!1,this.Init()},PauseGame:function(El){var Ik=document.getElementById("ctx");if(null==this.EndGameHandle&&("none"!=Ik.style.display||"controlReq"==El))if(this.Paused=!this.Paused,this.Paused)this.AISettings=GetAISettings(),this.RenderPause("GAME PAUSED"),null!=this.BackgroundAudio&&this.BackgroundAudio.pause();else{for(var hn=GetAISettings(),SB=0;SB<hn.length;SB++)if(hn[SB].AI!=this.AISettings[SB].AI||hn[SB].Smart!=this.AISettings[SB].Smart)return void this.ResetEngine();this.BackgroundAudio.play()}},OpenCloseControls:function(){this.PauseGame("controlReq");var El=document.getElementById("table-container"),Ik=document.getElementById("ctx");this.Paused?El.style.display="":El.style.display="none"},EngineStart:function(){this.PlayersInit(this.NumberOfPlayers);var El=this;document.onkeydown=function(Ik){for(var hn=0;hn<El.Players.length;hn++)El.Paused||El.Players[hn].isAI||El.Players[hn].dead||El.Players[hn].TryKeyDown(Ik.keyCode)},document.onkeyup=function(Ik){80==Ik.keyCode&&El.PauseGame(),82==Ik.keyCode&&El.ResetEngine(),67==Ik.keyCode&&El.OpenCloseControls();for(var hn=0;hn<El.Players.length;hn++)El.Paused||El.Players[hn].isAI||El.Players[hn].dead||El.Players[hn].TryKeyUp(Ik.keyCode)};for(var Ik=0;Ik<this.NumberOfPlayers;Ik++)if(this.AISettings[Ik].AI){var hn=InjectAI(this.Players[Ik]);hn.isRisky=!this.AISettings[Ik].Smart,this.AI.push(hn)}this.AILogicHandle=setInterval((function(){for(var Ik=0;Ik<El.AI.length;Ik++)El.AI[Ik].Update()}),10),this.EngineIntervalHandle=setInterval((function(){if(!El.Paused){MAP.InitRenderBasicMap(),MAP.RenderBombs();for(var Ik=0,hn=0;hn<El.Players.length;hn++)El.Players[hn].dead||(El.Players[hn].Update(),Ik++);if(Ik<2&&null==El.EndGameHandle){var SB=["WHITE","GREEN","RED","BLUE"];El.EndGameHandle=new Timer((function(){clearInterval(El.EngineIntervalHandle),MAP.InitRenderBasicMap(),MAP.RenderBombs();for(var Ik=-1,hn=0;hn<El.Players.length;hn++)El.Players[hn].dead||(El.Players[hn].Update(),Ik=hn);-1!=Ik&&El.Players[Ik].Update(),-1==Ik?El.RenderPause("DRAW GAME!"):El.RenderPause(SB[Ik]+" PLAYER WINS!")}),3e3)}}}),1e3/60)}},KEYBOARD_MAP=["","","","CANCEL","","","HELP","","BACK_SPACE","TAB","","","CLEAR","ENTER","RETURN","","SHIFT","CONTROL","ALT","PAUSE","CAPS_LOCK","KANA","EISU","JUNJA","FINAL","HANJA","","ESCAPE","CONVERT","NONCONVERT","ACCEPT","MODECHANGE","SPACE","PAGE_UP","PAGE_DOWN","END","HOME","LEFT","UP","RIGHT","DOWN","SELECT","PRINT","EXECUTE","PRINTSCREEN","INSERT","DELETE","","0","1","2","3","4","5","6","7","8","9","COLON","SEMICOLON","LESS_THAN","EQUALS","GREATER_THAN","QUESTION_MARK","AT","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","WIN","","CONTEXT_MENU","","SLEEP","NUMPAD0","NUMPAD1","NUMPAD2","NUMPAD3","NUMPAD4","NUMPAD5","NUMPAD6","NUMPAD7","NUMPAD8","NUMPAD9","MULTIPLY","ADD","SEPARATOR","SUBTRACT","DECIMAL","DIVIDE","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F19","F20","F21","F22","F23","F24","","","","","","","","","NUM_LOCK","SCROLL_LOCK","WIN_OEM_FJ_JISHO","WIN_OEM_FJ_MASSHOU","WIN_OEM_FJ_TOUROKU","WIN_OEM_FJ_LOYA","WIN_OEM_FJ_ROYA","","","","","","","","","","CIRCUMFLEX","EXCLAMATION","DOUBLE_QUOTE","HASH","DOLLAR","PERCENT","AMPERSAND","UNDERSCORE","OPEN_PAREN","CLOSE_PAREN","ASTERISK","PLUS","PIPE","HYPHEN_MINUS","OPEN_CURLY_BRACKET","CLOSE_CURLY_BRACKET","TILDE","","","","","VOLUME_MUTE","VOLUME_DOWN","VOLUME_UP","","","SEMICOLON","EQUALS","COMMA","MINUS","PERIOD","SLASH","BACK_QUOTE","","","","","","","","","","","","","","","","","","","","","","","","","","","OPEN_BRACKET","BACK_SLASH","CLOSE_BRACKET","QUOTE","","META","ALTGR","","WIN_ICO_HELP","WIN_ICO_00","","WIN_ICO_CLEAR","","","WIN_OEM_RESET","WIN_OEM_JUMP","WIN_OEM_PA1","WIN_OEM_PA2","WIN_OEM_PA3","WIN_OEM_WSCTRL","WIN_OEM_CUSEL","WIN_OEM_ATTN","WIN_OEM_FINISH","WIN_OEM_COPY","WIN_OEM_AUTO","WIN_OEM_ENLW","WIN_OEM_BACKTAB","ATTN","CRSEL","EXSEL","EREOF","PLAY","ZOOM","","PA1","WIN_OEM_CLEAR",""];function ShowKey(El,Ik,hn,SB){var Zd=SB.keyCode;hn.value=KEYBOARD_MAP[Zd],SB.preventDefault(),PlayerGen.KEYS[El][Ik]=Zd}function MaxP(El){GAME.NumberOfPlayers=El,GAME.ResetEngine(),GAME.Paused=!0,GAME.OpenCloseControls()}function GetAISettings(){for(var El=[],Ik=0;Ik<4;Ik++)El.push({AI:document.getElementById("player"+Ik+"AI").checked,Smart:document.getElementById("player"+Ik+"AI_MODE").checked});return El}window.onload=function(){GAME.Init()};var MAP={Canvas:null,Ctx:null,MapY:15,MapX:15,Map:null,TileDim:50,BombsMatrix:null,ExplosionMatrix:null,ExplosionRenderMatrix:null,WallDestroyRenderMatrix:null,PowerUpMatrix:null,PreDefinedPowerUpLocations:null,MapStatusEnum:Object.freeze({SOLID_BORDER:1,SOLID_WALL:2,WALL:3,FLOOR:4}),PowerUpEnum:Object.freeze({RANGE:0,BOMB:1,SPEED:3,PENALTY:8}),IsFloor:function(El,Ik){return this.Map[Ik][El]==this.MapStatusEnum.FLOOR},IsWall:function(El,Ik){return this.Map[Ik][El]==this.MapStatusEnum.WALL},Get2DArray:function(El,Ik){for(var hn=new Array(El),SB=0;SB<El;SB++)hn[SB]=new Array(Ik);return hn},GetBoundingCells:function(El,Ik){for(var hn=this,SB=[],Zd=-1;Zd<=1;Zd++)for(var OJ=-1;OJ<=1;OJ++)El+Zd<0||Ik+Zd<0?SB.push({Walkable:!1,Collides:function(El,Ik){return!0}}):SB.push({Walkable:this.Map[Ik+Zd][El+OJ]==this.MapStatusEnum.FLOOR||this.Map[Ik+Zd][El+OJ]==this.MapStatusEnum.WALL&&!1,_j:OJ,_i:Zd,Collides:function(SB,Zd){return(El+this._j)*hn.TileDim<=SB&&SB<=(El+this._j+1)*hn.TileDim&&(Ik+this._i)*hn.TileDim<=Zd&&Zd<=(Ik+this._i+1)*hn.TileDim}});return SB},GetCellXY:function(El,Ik){return{x:El*this.TileDim,y:Ik*this.TileDim}},CellPosToXY:function(El,Ik){return{x:Math.floor(El/this.TileDim),y:Math.floor(Ik/this.TileDim)}},_CellPosToXY:function(El){return{x:Math.floor(El.x/this.TileDim),y:Math.floor(El.y/this.TileDim)}},Init:function(El,Ik){this.Canvas=El,this.Ctx=Ik,this.InitPrepareMap(),this.InitRenderBasicMap()},SetRender:function(El,Ik,hn){switch(El){case this.MapStatusEnum.SOLID_BORDER:this.Ctx.drawImage(GAME.SpriteBankImage,0+16*3+.2,170,16,16,this.TileDim*hn,this.TileDim*Ik,this.TileDim,this.TileDim);break;case this.MapStatusEnum.SOLID_WALL:this.Ctx.drawImage(GAME.SpriteBankImage,0+16*4,170,16,16,this.TileDim*hn,this.TileDim*Ik,this.TileDim,this.TileDim);break;case this.MapStatusEnum.WALL:this.Ctx.drawImage(GAME.SpriteBankImage,0+16*2,170,16,16,this.TileDim*hn,this.TileDim*Ik,this.TileDim,this.TileDim);break;case this.MapStatusEnum.FLOOR:this.Ctx.drawImage(GAME.SpriteBankImage,0+16*0,170,16,16,this.TileDim*hn,this.TileDim*Ik,this.TileDim,this.TileDim);break;default:return!1}return!0},InitPrepareMap:function(){this.Canvas.width=this.TileDim*(this.MapX+0),this.Canvas.height=this.TileDim*(this.MapY+0),this.Map=this.Get2DArray(this.MapY,this.MapX),this.BombsMatrix=this.Get2DArray(this.MapY,this.MapX),this.ExplosionMatrix=this.Get2DArray(this.MapY,this.MapX),this.ExplosionRenderMatrix=this.Get2DArray(this.MapY,this.MapX),this.WallDestroyRenderMatrix=this.Get2DArray(this.MapY,this.MapX),this.PowerUpMatrix=this.Get2DArray(this.MapY,this.MapX),this.PreDefinedPowerUpLocations=this.Get2DArray(this.MapY,this.MapX);for(var El=0;El<this.MapY;El++)for(var Ik=0;Ik<this.MapX;Ik++){this.BombsMatrix[El][Ik]=null,this.ExplosionMatrix[El][Ik]=null,this.ExplosionRenderMatrix[El][Ik]=null,this.WallDestroyRenderMatrix[El][Ik]=null,this.PowerUpMatrix[El][Ik]=null,this.PreDefinedPowerUpLocations[El][Ik]=null;var hn=Math.random();if(0==El||El==this.MapY-1||0==Ik||Ik==this.MapX-1)this.Map[El][Ik]=this.MapStatusEnum.SOLID_BORDER;else if(Ik%2==0&&El%2==0)this.Map[El][Ik]=this.MapStatusEnum.SOLID_WALL;else if(hn<=.7){if(this.Map[El][Ik]=this.MapStatusEnum.WALL,Math.random()<=.4){var SB=[0,1,0,1,0,1,3,8],Zd=SB[Math.floor(Math.random()*SB.length)];this.PreDefinedPowerUpLocations[El][Ik]=Zd}}else this.Map[El][Ik]=this.MapStatusEnum.FLOOR}this.InitPrepareMapForPlayerStart()},InitPrepareMapForPlayerStart:function(){this.Map[0+1][0+1]=this.MapStatusEnum.FLOOR,this.Map[0+1][1+1]=this.MapStatusEnum.FLOOR,this.Map[1+1][0+1]=this.MapStatusEnum.FLOOR,this.Map[0+1][this.MapX-1-1]=this.MapStatusEnum.FLOOR,this.Map[1+1][this.MapX-1-1]=this.MapStatusEnum.FLOOR,this.Map[0+1][this.MapX-2-1]=this.MapStatusEnum.FLOOR,this.Map[this.MapY-2][0+1]=this.MapStatusEnum.FLOOR,this.Map[this.MapY-2][1+1]=this.MapStatusEnum.FLOOR,this.Map[this.MapY-3][0+1]=this.MapStatusEnum.FLOOR,this.Map[this.MapY-2][this.MapX-2]=this.MapStatusEnum.FLOOR,this.Map[this.MapY-2-1][this.MapX-2]=this.MapStatusEnum.FLOOR,this.Map[this.MapY-2][this.MapX-2-1]=this.MapStatusEnum.FLOOR},InitRenderBasicMap:function(){for(var El=0;El<this.MapY;El++)for(var Ik=0;Ik<this.MapX;Ik++)this.SetRender(this.Map[El][Ik],El,Ik)},RenderBombs:function(){for(var El=0;El<this.MapY;El++)for(var Ik=0;Ik<this.MapX;Ik++)if(null!=this.PowerUpMatrix[El][Ik]&&this.PowerUpMatrix[El][Ik].Render(),null!=this.BombsMatrix[El][Ik]&&(this.BombsMatrix[El][Ik].exploded?(this.ExplosionRenderMatrix[El][Ik]=this.BombsMatrix[El][Ik].GetExplosion(),this.ExplosionRenderMatrix[El][Ik].Activate(),this.BombsMatrix[El][Ik]=null):null!=this.ExplosionMatrix[El][Ik]?this.BombsMatrix[El][Ik].exploded=!0:this.BombsMatrix[El][Ik].Render()),null!=this.ExplosionRenderMatrix[El][Ik]&&(this.ExplosionRenderMatrix[El][Ik].over?this.ExplosionRenderMatrix[El][Ik]=null:this.ExplosionRenderMatrix[El][Ik].Render()),null!=this.WallDestroyRenderMatrix[El][Ik]&&(this.WallDestroyRenderMatrix[El][Ik].exploded?this.WallDestroyRenderMatrix[El][Ik]=null:this.WallDestroyRenderMatrix[El][Ik].Render()),null!=this.ExplosionMatrix[El][Ik]){null!=this.PowerUpMatrix[El][Ik]&&(this.PowerUpMatrix[El][Ik]=null);for(var hn=0;hn<GAME.Players.length;hn++)if(!GAME.Players[hn].dead){var SB=GAME.Players[hn].CellOnFoot();El==SB.y&&Ik==SB.x&&(GAME.Players[hn].dead=!0,GAME.Players[hn].SetDeadAnimation())}}for(var hn=0;hn<GAME.Players.length;hn++)null!=GAME.Players[hn].deadAnimation&&(GAME.Players[hn].deadAnimation.over?GAME.Players[hn].deadAnimation=null:GAME.Players[hn].deadAnimation.Render())}};function _GetCenterTile(El){return{x:El.x*MAP.TileDim+.5*MAP.TileDim,y:El.y*MAP.TileDim+.5*MAP.TileDim}}var PlayerGen={KEYS:[[38,40,37,39,32],[87,83,65,68,70],[73,75,74,76,72],[104,101,100,102,13]],PlayerMoveEnum:Object.freeze({DOWN:0,RIGHT:1,LEFT:2,UP:3}),PlayerKeyEnum:Object.freeze({DOWN:1,RIGHT:3,LEFT:2,UP:0,BOMB:4}),PlayerTypeEnum:Object.freeze({WHITE:1,GREEN:2,RED:3,BLUE:4}),CreatePlayer:function(El,Ik,hn){var SB=this,Zd;return{isAI:!1,x:El,y:Ik,MaxBombs:1,id:hn,BombRange:2,MoveSpeed:2.5,walking:!1,firstStep:!1,dead:!1,walkFrame:[2,0,1,0],walkFrameIdx:0,localTimeStamp:0,Ctx:MAP.Ctx,MovingPos:SB.PlayerMoveEnum.DOWN,frameIdx:0,deadAnimation:null,SetDeadAnimation:function(){var El=this;this.deadAnimation={x:El.x,y:El.y,pID:El.id,IntervalHandle:null,frames:[0,1,2,3,4,5,6,7,8],frameIdx:0,durationMs:2e3,over:!1,TimerHandle:null,Activate:function(){var El=this;this.IntervalHandle=setInterval((function(){if(null!=El.TimerHandle){if(GAME.Paused)return void(El.TimerHandle.On()&&El.TimerHandle.pause());El.TimerHandle.On()||El.TimerHandle.resume()}El.frameIdx=(El.frameIdx+1)%El.frames.length}),222),this.TimerHandle=new Timer((function(){clearInterval(El.IntervalHandle),El.over=!0}),El.durationMs)},Render:function(){MAP.Ctx.drawImage(GAME.SpriteBankImage,24*this.frames[this.frameIdx]+10,283+50*this.pID-1,19,22,this.x,this.y,MAP.TileDim,MAP.TileDim)}},this.deadAnimation.Activate()},Position:function(){return{x:this.x+MAP.TileDim/2,y:this.y+MAP.TileDim/2}},PositionFoot:function(){return{x:this.x+MAP.TileDim/2,y:this.y+.85*MAP.TileDim}},GetBoundPoints:function(){return[{x:this.x+.5*MAP.TileDim,y:this.y+.95*MAP.TileDim},{x:this.x+.3*MAP.TileDim,y:this.y+.85*MAP.TileDim},{x:this.x+.7*MAP.TileDim,y:this.y+.85*MAP.TileDim},{x:this.x+.5*MAP.TileDim,y:this.y+.7*MAP.TileDim}]},CellOn:function(){return{x:Math.floor(this.x/MAP.TileDim),y:Math.floor(this.y/MAP.TileDim)}},CellOnFoot:function(){var El=this.PositionFoot();return{x:Math.floor(El.x/MAP.TileDim),y:Math.floor(El.y/MAP.TileDim)}},CellOnFootOffset:function(El,Ik){var hn=this.PositionFoot();return{x:Math.floor((hn.x+El)/MAP.TileDim),y:Math.floor((hn.y+Ik)/MAP.TileDim)}},Update:function(){this.walking&&((this.localTimeStamp%7==0||this.firstStep)&&(this.frameIdx=this.walkFrame[this.walkFrameIdx%4],this.walkFrameIdx++,this.firstStep=!1),this.isAI||this.MoveTo(this.MovingPos)),this.isAI&&this.MoveToAi(this.MovingPos),this.Render(),this.localTimeStamp++},Render:function(){this.Ctx.drawImage(GAME.SpriteBankImage,10+3*this.MovingPos*24+24*this.frameIdx-2,259+50*this.id-1,22,24,this.x,this.y,MAP.TileDim,MAP.TileDim)},MoveDirection:function(El){this.MovingPos=El,this.walking||(this.firstStep=!0),this.walking=!0},NewPositionCollidesWithMap:function(){var El=this.CellOnFoot();if(El.x>MAP.MapX-2||El.y>MAP.MapY-2)return!0;for(var Ik=MAP.GetBoundingCells(El.x,El.y),hn=this.PositionFoot(),SB=this.GetBoundPoints(),Zd=0;Zd<Ik.length;Zd++)if(!Ik[Zd].Walkable)for(var OJ=0;OJ<SB.length;OJ++)if(Ik[Zd].Collides(SB[OJ].x,SB[OJ].y))return!0;return!1},NewPositionCollidesWithBomb:function(El){var Ik=this.CellOnFoot();return null!=MAP.BombsMatrix[Ik.y][Ik.x]&&(null==El||(Ik.y!=El.y||Ik.x!=El.x))},AIPlan:null,AIStack:{path:[],type:AI_STACK_TYPE.FOLLOW,ok:!1},MoveToAi:function(El){if(null==this.AIPlan){if(0==this.AIStack.path.length)return;this.AIPlan=_GetCenterTile(this.AIStack.path.pop())}this.walking=!0;var Ik=this.x,hn=this.y,Zd=this.CellOnFoot(),OJ;null!=MAP.BombsMatrix[Zd.y][Zd.x]||(Zd=null);var Pp=this.PositionFoot();this.AIPlan.x<Pp.x?(Pp.x-this.MoveSpeed<=this.AIPlan.x?(this.SetCenterCell(),this.AIPlan=null):this.x-=this.MoveSpeed,this.MovingPos=SB.PlayerMoveEnum.LEFT):this.AIPlan.x>Pp.x?(Pp.x+this.MoveSpeed>=this.AIPlan.x?(this.SetCenterCell(),this.AIPlan=null):this.x+=this.MoveSpeed,this.MovingPos=SB.PlayerMoveEnum.RIGHT):this.AIPlan.y<Pp.y?(Pp.y-this.MoveSpeed<=this.AIPlan.y?(this.SetCenterCell(),this.AIPlan=null):this.y-=this.MoveSpeed,this.MovingPos=SB.PlayerMoveEnum.UP):this.AIPlan.y>Pp.y?(Pp.y+this.MoveSpeed>=this.AIPlan.y?(this.SetCenterCell(),this.AIPlan=null):this.y+=this.MoveSpeed,this.MovingPos=SB.PlayerMoveEnum.DOWN):(this.SetCenterCell(),this.AIPlan=null,this.walking=!1),this.NewPositionCollidesWithMap()&&(this.y=hn,this.x=Ik),this.NewPositionCollidesWithBomb(Zd)&&(this.y=hn,this.x=Ik),Zd=this.CellOnFoot(),null!=MAP.PowerUpMatrix[Zd.y][Zd.x]&&this.ConsumePowerUp(Zd.x,Zd.y)},MoveTo:function(El){var Ik=this.x,hn=this.y,Zd=this.CellOnFoot(),OJ;switch(null!=MAP.BombsMatrix[Zd.y][Zd.x]||(Zd=null),El){case SB.PlayerMoveEnum.DOWN:this.y+=this.MoveSpeed;break;case SB.PlayerMoveEnum.RIGHT:this.x+=this.MoveSpeed;break;case SB.PlayerMoveEnum.LEFT:this.x-=this.MoveSpeed;break;case SB.PlayerMoveEnum.UP:this.y-=this.MoveSpeed;break}this.NewPositionCollidesWithMap()&&(this.y=hn,this.x=Ik),this.NewPositionCollidesWithBomb(Zd)&&(this.y=hn,this.x=Ik),Zd=this.CellOnFoot(),null!=MAP.PowerUpMatrix[Zd.y][Zd.x]&&this.ConsumePowerUp(Zd.x,Zd.y)},SetCenterCell:function(){var El=this.CellOnFoot(),Ik={x:El.x*MAP.TileDim+.5*MAP.TileDim,y:El.y*MAP.TileDim+.5*MAP.TileDim};this.y=Ik.y-.85*MAP.TileDim,this.x=Ik.x-MAP.TileDim/2},ConsumePowerUp:function(El,Ik){var hn=MAP.PowerUpMatrix[Ik][El];switch(MAP.PowerUpMatrix[Ik][El]=null,hn.Sound.play(),hn.type){case MAP.PowerUpEnum.RANGE:this.BombRange++;break;case MAP.PowerUpEnum.BOMB:this.MaxBombs++;break;case MAP.PowerUpEnum.SPEED:this.MoveSpeed++;break;case MAP.PowerUpEnum.PENALTY:this.MoveSpeed-=.5;break}},SetBomb:function(){if(0!=this.MaxBombs){var El=this.CellOnFoot();if(null==MAP.BombsMatrix[El.y][El.x]){var Ik=GetBomb(El.x,El.y,this);MAP.BombsMatrix[El.y][El.x]=Ik,Ik.Activate()}}},TryKeyDown:function(El){El==SB.KEYS[this.id][SB.PlayerKeyEnum.UP]?this.MoveDirection(SB.PlayerMoveEnum.UP):El==SB.KEYS[this.id][SB.PlayerKeyEnum.LEFT]?this.MoveDirection(SB.PlayerMoveEnum.LEFT):El==SB.KEYS[this.id][SB.PlayerKeyEnum.DOWN]?this.MoveDirection(SB.PlayerMoveEnum.DOWN):El==SB.KEYS[this.id][SB.PlayerKeyEnum.RIGHT]?this.MoveDirection(SB.PlayerMoveEnum.RIGHT):El==SB.KEYS[this.id][4]&&this.SetBomb()},TryKeyUp:function(El){(El==SB.KEYS[this.id][SB.PlayerKeyEnum.UP]&&this.MovingPos==SB.PlayerMoveEnum.UP||El==SB.KEYS[this.id][SB.PlayerKeyEnum.LEFT]&&this.MovingPos==SB.PlayerMoveEnum.LEFT||El==SB.KEYS[this.id][SB.PlayerKeyEnum.DOWN]&&this.MovingPos==SB.PlayerMoveEnum.DOWN||El==SB.KEYS[this.id][SB.PlayerKeyEnum.RIGHT]&&this.MovingPos==SB.PlayerMoveEnum.RIGHT)&&(this.walking=!1,this.frameIdx=0)},KeyDown:function(El){El==SB.PlayerKeyEnum.UP?this.MoveDirection(SB.PlayerMoveEnum.UP):El==SB.PlayerKeyEnum.LEFT?this.MoveDirection(SB.PlayerMoveEnum.LEFT):El==SB.PlayerKeyEnum.DOWN?this.MoveDirection(SB.PlayerMoveEnum.DOWN):El==SB.PlayerKeyEnum.RIGHT?this.MoveDirection(SB.PlayerMoveEnum.RIGHT):El==SB.PlayerKeyEnum.BOMB&&this.SetBomb()},KeyUp:function(El){(El==SB.PlayerKeyEnum.UP&&this.MovingPos==SB.PlayerMoveEnum.UP||El==SB.PlayerKeyEnum.LEFT&&this.MovingPos==SB.PlayerMoveEnum.LEFT||El==SB.PlayerKeyEnum.DOWN&&this.MovingPos==SB.PlayerMoveEnum.DOWN||El==SB.PlayerKeyEnum.RIGHT&&this.MovingPos==SB.PlayerMoveEnum.RIGHT)&&(this.walking=!1,this.frameIdx=0)}}}};function Timer(El,Ik){var hn,SB,Zd=Ik,OJ=!1;this.pause=function(){window.clearTimeout(hn),Zd-=new Date-SB,OJ=!1},this.On=function(){return OJ},this.resume=function(){SB=new Date,window.clearTimeout(hn),hn=window.setTimeout(El,Zd),OJ=!0},this.resume()}function getVectorAB(El,Ik){return{X:Ik.X-El.X,Y:Ik.Y-El.Y}}function Vector2(El,Ik){return{X:El,Y:Ik}}function CrossProductVec(El,Ik){return El.X*Ik.Y-Ik.X*El.Y}function ScalarVec(El,Ik){return El.X*Ik.X+El.Y*Ik.Y}function VectorAngle(El,Ik){return Math.acos(ScalarVec(El,Ik)/(Math.sqrt(ScalarVec(El,El))*Math.sqrt(ScalarVec(Ik,Ik))))}function VectorAngleToDeg(El){return El*(180/Math.PI)}function toDeg(El){return El*(180/Math.PI)}function toRad(El){return El*(Math.PI/180)}function getDistance(El,Ik){return(El.X-Ik.X)*(El.X-Ik.X)+(El.Y-Ik.Y)*(El.Y-Ik.Y)}function getCentroid(El,Ik,hn){return{X:(El.X+Ik.X+hn.X)/3,Y:(El.Y+Ik.Y+hn.Y)/3}}function getDegAngle(El,Ik){var hn=Math.atan2(Ik.Y-El.Y,Ik.X-El.X)*(180/Math.PI);return hn<0?hn+360:hn}function getRadAngle(El,Ik){return Math.atan2(Ik.Y-El.Y,Ik.X-El.X)}function rotateDeg(El,Ik){var hn=Ik*(Math.PI/180),SB=Math.cos(hn),Zd=Math.sin(hn);return{X:SB*El.X-Zd*El.Y,Y:Zd*El.X+SB*El.Y}}function rotate(El,Ik){var hn=Math.cos(Ik),SB=Math.sin(Ik);return{X:hn*El.X-SB*El.Y,Y:SB*El.X+hn*El.Y}}function vectorPlus(El,Ik){return{X:El.X+Ik.X,Y:El.Y+Ik.Y}}function scaleVector(El,Ik){return{X:El.X*Ik,Y:El.Y*Ik}}function getABCArea(El,Ik,hn){return.5*Math.abs(El.X*(Ik.Y-hn.Y)+Ik.X*(hn.Y-El.Y)+hn.X*(El.Y-Ik.Y))}function vecLen(El){return Math.sqrt(El.X*El.X+El.Y*El.Y)}function GetAnimatedWall(El,Ik){return{x:El,y:Ik,IntervalHandle:null,frames:[0,1,2,3,4,5],frameIdx:0,durationMs:500,exploded:!1,TimerHandle:null,Activate:function(){var El=this;this.IntervalHandle=setInterval((function(){if(null!=El.TimerHandle){if(GAME.Paused)return void(El.TimerHandle.On()&&El.TimerHandle.pause());El.TimerHandle.On()||El.TimerHandle.resume()}El.frameIdx=(El.frameIdx+1)%El.frames.length}),83),this.TimerHandle=new Timer((function(){clearInterval(El.IntervalHandle),El.exploded=!0;var Ik=GeneratePowerUp(El.x,El.y);null!=Ik&&(MAP.PowerUpMatrix[El.y][El.x]=Ik)}),El.durationMs)},Render:function(){MAP.Ctx.drawImage(GAME.SpriteBankImage,58+16*this.frames[this.frameIdx],205,16,16,MAP.TileDim*this.x,MAP.TileDim*this.y,MAP.TileDim,MAP.TileDim)}}}function GeneratePowerUp(El,Ik){if(null==MAP.PreDefinedPowerUpLocations[Ik][El])return null;var hn={x:El,y:Ik,Sound:null,type:MAP.PreDefinedPowerUpLocations[Ik][El],Init:function(){this.Sound=new Audio("./audio/powerup.mp3"),this.Sound.volume=.3},Render:function(){MAP.Ctx.drawImage(GAME.SpriteBankImage,16*this.type,188,16,16,MAP.TileDim*this.x,MAP.TileDim*this.y,MAP.TileDim,MAP.TileDim)}};return hn.Init(),hn}